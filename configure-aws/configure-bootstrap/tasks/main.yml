---
- name: Pip exists
  ansible.builtin.raw: pip --version
  args:
    executable: /bin/bash
  ignore_errors: true
  register: pip_output

- name: ansible exists
  ansible.builtin.raw: ansible --version
  ignore_errors: true
  register: ansible_output

- name: Get pip installer
  ansible.builtin.raw: curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
  when: pip_output.rc != 0

- name: Install pip
  ansible.builtin.raw: python3 get-pip.py --user
  when: pip_output.rc != 0

- name: Install ansible
  ansible.builtin.raw: python3 -m pip install --user ansible
  when: ansible_output.rc != 0

- name: Install boto3 python package
  ansible.builtin.pip:
    name: boto3

- name: Ensures /etc/ansible exists
  become: true
  ansible.builtin.file:
    path: /etc/ansible
    state: directory

- name: Copy ansible.cfg
  become: true
  ansible.builtin.copy:
    src: files/ansible.cfg
    dest: /etc/ansible/ansible.cfg

- name: Copy my_keypair.pem to bootstrap
  ansible.builtin.copy:
    src: files/my_keypair.pem
    dest: /home/ec2-user/my_keypair.pem
    mode: '0400'

- name: Copy AMQ Broker install to bootstrap
  ansible.builtin.copy:
    force: false
    src: files/amq-broker-7.11.6-bin.zip
    dest: /home/ec2-user/amq-broker-7.11.6-bin.zip

- name: Install collection redhat.amq_broker
  community.general.ansible_galaxy_install:
    type: collection
    name: redhat.amq_broker

- name: Get AMQ nodes
  amazon.aws.ec2_instance_info:
    aws_access_key: "{{ aws_access_key }}"
    aws_secret_key: "{{ aws_secret_key }}"
    region: "{{ region }}"
    filters:
      "tag:Name": "amq*"
  register: ec2_node_info

- name: Create empty private_dns_names collection
  set_fact:
    private_dns_names: []

- name: Add DNS names to private_dns_names collection
  set_fact:
    private_dns_names: "{{ private_dns_names + [ item['network_interfaces'][0].private_dns_name ] }}"
  loop: "{{ ec2_node_info['instances'] }}"
  loop_control:
    label: "{{ item.network_interfaces }}"

- name: Scan for SSH host keys
  ansible.builtin.shell: ssh-keyscan {{ item }} 2>/dev/null
  register: ssh_scan
  loop: "{{ private_dns_names }}"

- name: Update known_hosts
  ansible.builtin.known_hosts:
    name: "{{ item.item }}"
    key: "{{ item.stdout }}"
  loop: "{{ ssh_scan.results }}"

- name: Copy playground inventory
  ansible.builtin.copy:
    src: ../../../inventory
    dest: /home/ec2-user/

- name: Copy playground deploy-amq-clustered.yml
  ansible.builtin.copy:
    src: ../../deploy-amq-clustered.yml
    dest: /home/ec2-user/

- name: Copy playground remove-amq.yml
  ansible.builtin.copy:
    src: ../../remove-amq.yml
    dest: /home/ec2-user/

- name: Ping AMQ hosts
  ansible.builtin.shell: |
    eval "$(ssh-agent)"
    ssh-add ~/my_keypair.pem
    ansible all -i /home/ec2-user/inventory/group_vars/all.yml -m ansible.builtin.ping

- name: Get Bootstrap nodes
  amazon.aws.ec2_instance_info:
    aws_access_key: "{{ aws_access_key }}"
    aws_secret_key: "{{ aws_secret_key }}"
    region: "{{ region }}"
    filters:
      "tag:Name": "bootstrap*"
  register: ec2_bootstrap_node_info

- name: SSH to boostrap
  ansible.builtin.debug:
    msg: "ssh -i configure-bootstrap/files/my_keypair.pem ec2-user@{{ ec2_bootstrap_node_info['instances'][0].network_interfaces[0].association.public_dns_name }}"